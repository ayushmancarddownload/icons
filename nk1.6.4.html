<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poster Studio Pro | GitHub Hosted</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=Playfair+Display:wght@700&family=Bebas+Neue&family=Pacifico&family=Noto+Sans+Devanagari:wght@400;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --------------------------------------------------------------------------
           1. CORE & GLOBAL THEME
           -------------------------------------------------------------------------- */
        :root {
            --dynamic-color-1: #0f172a;
            --dynamic-color-2: #334155;
        }
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #020617; 
            color: #f8fafc;
            user-select: none;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-nav { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .custom-scroll::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 10px; }

        /* --------------------------------------------------------------------------
           2. HOME VIEW (GALLERY)
           -------------------------------------------------------------------------- */
        .masonry-grid {
            columns: 2;
            column-gap: 12px;
            padding: 12px;
        }
        @media (min-width: 640px) { .masonry-grid { columns: 3; } }
        @media (min-width: 1024px) { .masonry-grid { columns: 5; } }

        .masonry-item { break-inside: avoid; margin-bottom: 12px; opacity: 0; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .masonry-item:active { transform: scale(0.96); }

        /* --------------------------------------------------------------------------
           3. EDITOR VIEW (WORKSPACE)
           -------------------------------------------------------------------------- */
        .draggable-element {
            cursor: move;
            position: absolute;
            touch-action: none;
            padding: 6px 12px;
            border: 2px solid transparent;
            border-radius: 8px;
            white-space: pre-wrap;
            max-width: 85%;
            z-index: 50;
            line-height: 1.2;
        }
        .draggable-element.selected {
            border: 2px dashed #6366f1;
            background: rgba(99, 102, 241, 0.15);
        }

        /* AMBITION STYLE: Card Animation */
        #canvasProfileOverlay {
            background: linear-gradient(45deg, var(--dynamic-color-1), var(--dynamic-color-2), var(--dynamic-color-1));
            background-size: 400% 400%;
            animation: ambitionMove 10s ease infinite;
        }
        @keyframes ambitionMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Fixed Workspace Structure (No Rounded Edges on Image/Card) */
        #captureArea {
            width: 100%;
            max-width: 360px;
            background-color: #000;
        }
        @media (max-width: 380px) { #captureArea { max-width: 300px; } }

        /* Utilities */
        .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        #msgBox { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; display: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Toast UI -->
    <div id="msgBox" class="bg-white text-slate-900 px-6 py-2.5 rounded-full shadow-2xl font-bold text-xs animate-fade-in flex items-center gap-2 border border-indigo-100">
        <i class="fas fa-sparkles text-indigo-500"></i>
        <span id="msgContent"></span>
    </div>

    <!-- ==========================================
         VIEW: HOME
         ========================================== -->
    <section id="homeView" class="h-screen flex flex-col">
        <nav class="glass-nav px-4 h-16 flex items-center justify-between shrink-0 z-40">
            <div class="flex items-center gap-2">
                <div class="w-9 h-9 bg-indigo-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-images text-white text-sm"></i>
                </div>
                <h1 class="font-extrabold text-white uppercase text-xs sm:text-sm tracking-tighter">Poster Studio <span class="text-indigo-400">Pro</span></h1>
            </div>
            <button onclick="toggleSetupModal(true)" class="flex items-center gap-2 bg-white/5 p-1 pr-3 rounded-full border border-white/5 hover:bg-white/10 transition">
                <img id="navPic" src="" class="w-8 h-8 rounded-full object-cover bg-slate-800">
                <span id="navNameDisplay" class="text-[10px] font-bold uppercase text-white/70 hidden xs:block">Profile</span>
            </button>
        </nav>

        <main class="flex-1 overflow-y-auto bg-slate-950" id="galleryScrollArea">
            <div id="masonryContainer" class="masonry-grid max-w-7xl mx-auto"></div>
            <div id="loader" class="flex flex-col items-center py-20">
                <div class="w-8 h-8 border-4 border-white/5 border-t-indigo-500 rounded-full animate-spin"></div>
            </div>
        </main>
    </section>

    <!-- ==========================================
         VIEW: EDITOR
         ========================================== -->
    <section id="editorView" class="fixed inset-0 z-50 bg-slate-950 flex flex-col hidden overflow-hidden">
        <header class="h-16 glass-nav flex items-center justify-between px-4 shrink-0">
            <button onclick="showView('home')" class="text-white/40 hover:text-white p-2">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
            
            <div class="flex items-center gap-2">
                <button onclick="sharePoster()" class="bg-white/5 hover:bg-white/10 text-white p-2 px-3 rounded-xl border border-white/5 text-[10px] font-bold flex items-center gap-2 transition uppercase">
                    <i class="fas fa-share-nodes text-xs"></i> <span>Share</span>
                </button>
                <button onclick="downloadPoster(2)" class="bg-slate-800 hover:bg-slate-700 text-white p-2 px-3 rounded-xl text-[10px] font-bold flex items-center gap-2 transition">
                    <i class="fas fa-download text-xs"></i> SD
                </button>
                <button onclick="downloadPoster(5)" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 px-4 rounded-xl text-[10px] font-bold flex items-center gap-2 transition shadow-lg shadow-indigo-600/20">
                    <i class="fas fa-crown text-amber-300 text-xs"></i> HD PRO
                </button>
            </div>
        </header>

        <div id="editorWorkspace" class="flex-1 relative flex flex-col items-center justify-start sm:justify-center p-4 overflow-y-auto bg-slate-950" onclick="deselectAll()">
            <div id="captureArea" class="flex flex-col shadow-[0_40px_100px_rgba(0,0,0,0.9)] shrink-0" onclick="event.stopPropagation()">
                <!-- POSTER IMAGE SECTION (No Round Edges) -->
                <div id="imagePart" class="relative w-full bg-slate-800 overflow-hidden shrink-0">
                    <img id="canvasMainImage" src="" class="w-full h-auto block pointer-events-none" crossorigin="anonymous">
                    <div id="dragContainer" class="absolute inset-0 z-20"></div>
                </div>
                
                <!-- BRAND CARD SECTION (Animated Strip After Image) -->
                <div id="canvasProfileOverlay" class="relative z-30 p-6 flex flex-row items-center border-t border-white/10 w-full transition-all">
                    <div id="canvasAvatarContainer" class="relative shrink-0">
                        <img id="canvasAvatar" src="" class="w-14 h-14 object-cover border-2 border-white/20 shadow-xl rounded-full bg-slate-800">
                    </div>
                    <div id="canvasInfoText" class="flex-1 ml-4 min-w-0 text-left">
                        <h4 id="canvasName" class="text-white font-bold text-base leading-tight truncate"></h4>
                        <p id="canvasBio" class="text-white/60 text-[9px] uppercase tracking-widest font-semibold mt-1 truncate"></p>
                    </div>
                    <div class="text-right shrink-0 ml-2 opacity-20">
                        <span id="domainTag" class="text-[9px] text-white font-black italic tracking-tighter uppercase">STUDIO PRO</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- TOOLBAR PANELS -->
        <div id="toolPanelArea" class="bg-slate-900/95 backdrop-blur-2xl border-t border-white/10 p-4 shrink-0 pb-8 z-50">
            <div id="panelText" class="tool-panel hidden space-y-4">
                <div class="flex gap-2">
                    <input type="text" id="textInput" placeholder="Write text..." class="flex-1 px-4 py-3 bg-white/5 border border-white/10 rounded-2xl text-white outline-none focus:border-indigo-500 text-sm">
                    <button onclick="addNewText()" class="bg-indigo-600 text-white px-6 rounded-2xl font-bold text-sm">Add</button>
                </div>
                <div id="textEditPanel" class="hidden flex flex-wrap gap-3 items-center bg-white/5 p-3 rounded-2xl border border-white/10">
                    <select id="fontSelect" onchange="updateTextStyling()" class="bg-slate-950 text-white text-[10px] p-2 rounded-xl outline-none font-bold uppercase flex-1">
                        <option value="'Outfit', sans-serif">Outfit</option>
                        <option value="'Playfair Display', serif">Playfair</option>
                        <option value="'Noto Sans Devanagari', sans-serif">Hindi</option>
                        <option value="'Pacifico', cursive">Pacifico</option>
                    </select>
                    <div class="flex-1 min-w-[100px]">
                        <input type="range" id="sizeRange" min="12" max="150" value="28" oninput="updateTextStyling()" class="w-full h-1 bg-white/10 rounded-lg appearance-none cursor-pointer accent-indigo-500">
                    </div>
                    <input type="color" id="colorPicker" oninput="updateTextStyling()" class="w-8 h-8 rounded-lg border-none bg-transparent cursor-pointer">
                    <button onclick="deleteSelectedText()" class="text-rose-500 p-2"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>

            <div id="panelLayout" class="tool-panel hidden flex justify-around p-2">
                <button onclick="setTheme('left')" class="flex flex-col items-center gap-2 text-white/40 hover:text-white transition group">
                    <div class="w-12 h-12 bg-white/5 rounded-2xl flex items-center justify-center group-hover:bg-indigo-50 transition-all group-hover:text-slate-900"><i class="fas fa-align-left text-lg"></i></div>
                    <span class="text-[9px] font-bold uppercase tracking-widest">Left</span>
                </button>
                <button onclick="setTheme('center')" class="flex flex-col items-center gap-2 text-white/40 hover:text-white transition group">
                    <div class="w-12 h-12 bg-white/5 rounded-2xl flex items-center justify-center group-hover:bg-indigo-50 transition-all group-hover:text-slate-900"><i class="fas fa-align-center text-lg"></i></div>
                    <span class="text-[9px] font-bold uppercase tracking-widest">Center</span>
                </button>
                <button onclick="setTheme('right')" class="flex flex-col items-center gap-2 text-white/40 hover:text-white transition group">
                    <div class="w-12 h-12 bg-white/5 rounded-2xl flex items-center justify-center group-hover:bg-indigo-50 transition-all group-hover:text-slate-900"><i class="fas fa-align-right text-lg"></i></div>
                    <span class="text-[9px] font-bold uppercase tracking-widest">Right</span>
                </button>
            </div>

            <div id="panelStyles" class="tool-panel hidden space-y-4">
                <div id="bgSelectors" class="flex gap-4 overflow-x-auto whitespace-nowrap custom-scroll py-2 px-2"></div>
            </div>

            <div id="panelAvatar" class="tool-panel hidden flex justify-around p-2 gap-4">
                <button onclick="setShape('rounded-full')" class="w-10 h-10 rounded-full border-2 border-white/20 bg-slate-800 hover:border-indigo-500 transition"></button>
                <button onclick="setShape('rounded-2xl')" class="w-10 h-10 rounded-2xl border-2 border-white/20 bg-slate-800 hover:border-indigo-500 transition"></button>
                <button onclick="setShape('shape-squircle')" class="w-10 h-10 shape-squircle border-2 border-white/20 bg-slate-800 hover:border-indigo-500 transition"></button>
                <button onclick="setShape('shape-hexagon')" class="w-10 h-10 shape-hexagon border-2 border-white/20 bg-slate-800 hover:border-indigo-500 transition"></button>
            </div>
        </div>

        <nav class="h-20 bg-slate-900 border-t border-white/5 flex items-center justify-around shrink-0 px-2 pb-6">
            <button onclick="showPanel('Text')" class="tab-btn flex flex-col items-center gap-1.5 text-white/30 transition-all">
                <i class="fas fa-font text-lg"></i><span class="text-[9px] uppercase font-black tracking-tighter">Content</span>
            </button>
            <button onclick="showPanel('Layout')" class="tab-btn flex flex-col items-center gap-1.5 text-white/30 transition-all">
                <i class="fas fa-layer-group text-lg"></i><span class="text-[9px] uppercase font-black tracking-tighter">Layout</span>
            </button>
            <button onclick="showPanel('Avatar')" class="tab-btn flex flex-col items-center gap-1.5 text-white/30 transition-all">
                <i class="fas fa-circle-user text-lg"></i><span class="text-[9px] uppercase font-black">Avatar</span>
            </button>
            <button onclick="showPanel('Styles')" class="tab-btn flex flex-col items-center gap-1.5 text-white/30 transition-all">
                <i class="fas fa-palette text-lg"></i><span class="text-[9px] uppercase font-black">Style</span>
            </button>
        </nav>
    </section>

    <!-- SETUP ONBOARDING MODAL -->
    <div id="setupModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950/90 backdrop-blur-xl hidden">
        <div class="bg-white rounded-[2.5rem] p-10 max-w-sm w-full mx-4 shadow-2xl animate-fade-in text-slate-900 relative">
            <button onclick="toggleSetupModal(false)" class="absolute top-6 right-6 text-slate-300 hover:text-slate-600 transition"><i class="fas fa-times-circle text-2xl"></i></button>
            <div class="mb-6 text-center">
                <h2 class="text-2xl font-black tracking-tighter uppercase">My Profile</h2>
                <p class="text-slate-500 text-xs mt-1">Information poster card mein juda rahega</p>
            </div>
            <div class="space-y-4 mb-8">
                <div class="relative w-24 h-24 mx-auto mb-6">
                    <img id="setupPreview" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="w-full h-full rounded-[2rem] object-cover border-4 border-slate-100 bg-slate-50 shadow-inner">
                    <label class="absolute bottom-0 right-0 bg-indigo-600 text-white p-2 rounded-2xl cursor-pointer shadow-xl border-4 border-white transition hover:scale-110">
                        <i class="fas fa-plus text-xs"></i>
                        <input type="file" id="setupFile" class="hidden" accept="image/*">
                    </label>
                </div>
                <div class="space-y-3">
                    <input type="text" id="setupName" placeholder="Full Name" class="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-100 outline-none focus:ring-4 focus:ring-indigo-500/10 transition-all font-bold">
                    <input type="text" id="setupBio" placeholder="Designation / Tagline" class="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-100 outline-none focus:ring-4 focus:ring-indigo-500/10 transition-all font-bold">
                </div>
            </div>
            <button onclick="saveInitialSetup()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black shadow-2xl shadow-indigo-500/30 hover:bg-indigo-700 transition-all active:scale-95 uppercase">Save Branding</button>
        </div>
    </div>

    <!-- ==========================================
         JAVASCRIPT MODULES
         ========================================== -->
    <script>
        /* -------------------------------------------
           MODULE 1: CONFIG (Fill GitHub Here)
           ------------------------------------------- */
        const githubUser = "ayushmancarddownload"; // Apna Username dalein
        const githubRepo = "icons";     // Apne Repo ka naam dalein
        const githubPath = "img";          // Images folder ka naam

        let currentUser = { name: "Creator", bio: "Signature Tagline", pic: "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" };
        let selectedElement = null;
        let assets = []; 

        const premiumGradients = [
            { name: "Ambition", style: "animated" }, 
            { name: "Midnight", style: "#0f172a" },
            { name: "Indigo", style: "linear-gradient(135deg, #1e1b4b, #312e81)" },
            { name: "Purple", style: "linear-gradient(135deg, #2e1065, #4c1d95)" },
            { name: "Ruby", style: "linear-gradient(135deg, #4c0519, #881337)" },
            { name: "Black", style: "#000000" }
        ];

        window.onload = () => {
            loadUser();
            fetchGitHubImages();
            initTools();
            showView('home');
        };

        /* -------------------------------------------
           MODULE 2: GITHUB API & NAVIGATION
           ------------------------------------------- */
        async function fetchGitHubImages() {
            if(githubUser === "YOUR_USERNAME") {
                assets = ["https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?q=80&w=600", "https://images.unsplash.com/photo-1529139513402-e209979821ed?q=80&w=600", "https://images.unsplash.com/photo-1539109132314-34a77ad70327?q=80&w=600"];
                initGallery();
                return;
            }
            try {
                const res = await fetch(`https://api.github.com/repos/${githubUser}/${githubRepo}/contents/${githubPath}`);
                const data = await res.json();
                if(Array.isArray(data)) {
                    assets = data.filter(f => /\.(jpe?g|png|webp)$/i.test(f.name)).map(f => f.download_url);
                    initGallery();
                }
            } catch(e) { showMessage("GitHub load error!"); }
        }

        function showView(view) {
            if(view === 'home') {
                document.getElementById('homeView').classList.remove('hidden');
                document.getElementById('editorView').classList.add('hidden');
            } else {
                document.getElementById('homeView').classList.add('hidden');
                document.getElementById('editorView').classList.remove('hidden');
            }
        }

        function showMessage(text) {
            const box = document.getElementById('msgBox');
            document.getElementById('msgContent').innerText = text;
            box.style.display = 'flex';
            setTimeout(() => { box.style.display = 'none'; }, 2500);
        }

        /* -------------------------------------------
           MODULE 3: GALLERY & DYNAMIC COLOR
           ------------------------------------------- */
        function initGallery() {
            const container = document.getElementById('masonryContainer');
            container.innerHTML = '';
            // RANDOM SHUFFLE
            const shuffled = [...assets].sort(() => Math.random() - 0.5);
            shuffled.forEach((url, idx) => {
                const div = document.createElement('div');
                div.className = 'masonry-item animate-fade-in';
                div.style.animationDelay = `${idx * 50}ms`;
                div.innerHTML = `<div class="relative group rounded-[1.5rem] overflow-hidden bg-slate-900 border border-white/5 shadow-lg" onclick="openStudio('${url}')">
                    <img src="${url}" class="w-full h-auto opacity-90 group-hover:opacity-100 transition-opacity">
                </div>`;
                container.appendChild(div);
            });
            document.getElementById('loader').classList.add('hidden');
        }

        function extractColors(imgUrl) {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = imgUrl;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 5; canvas.height = 5;
                ctx.drawImage(img, 0, 0, 5, 5);
                const p1 = ctx.getImageData(0, 0, 1, 1).data;
                const p2 = ctx.getImageData(4, 4, 1, 1).data;
                document.documentElement.style.setProperty('--dynamic-color-1', `rgb(${p1[0]}, ${p1[1]}, ${p1[2]})`);
                document.documentElement.style.setProperty('--dynamic-color-2', `rgb(${p2[0]}, ${p2[1]}, ${p2[2]})`);
            };
        }

        /* -------------------------------------------
           MODULE 4: STUDIO & TOOLS
           ------------------------------------------- */
        function openStudio(url) {
            document.getElementById('canvasMainImage').src = url;
            extractColors(url);
            document.getElementById('dragContainer').innerHTML = '';
            showView('editor');
            showPanel('Text');
            deselectAll();
            setTheme('left'); 
            applyBrandStrip(premiumGradients[0]);
        }

        function showPanel(id) {
            document.querySelectorAll('.tool-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById('panel' + id).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.replace('text-white', 'text-white/30'));
            const active = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.innerText.includes(id.toUpperCase()));
            if(active) active.classList.replace('text-white/30', 'text-white');
        }

        function initTools() {
            const container = document.getElementById('bgSelectors');
            premiumGradients.forEach(grad => {
                const btn = document.createElement('button');
                btn.className = 'w-10 h-10 rounded-xl border-2 border-white/10 shrink-0 hover:scale-110 transition shadow-lg';
                btn.style.background = grad.style === 'animated' ? 'linear-gradient(45deg, #6366f1, #a855f7)' : grad.style;
                btn.onclick = () => applyBrandStrip(grad);
                container.appendChild(btn);
            });
        }

        function applyBrandStrip(theme) {
            const overlay = document.getElementById('canvasProfileOverlay');
            if(theme.style === 'animated') {
                overlay.style.animation = "ambitionMove 10s ease infinite";
                overlay.style.background = "linear-gradient(45deg, var(--dynamic-color-1), var(--dynamic-color-2), var(--dynamic-color-1))";
                overlay.style.backgroundSize = "400% 400%";
            } else {
                overlay.style.animation = "none";
                overlay.style.background = theme.style;
                overlay.style.backgroundSize = "auto";
            }
            showMessage(`${theme.name} theme!`);
        }

        /* -------------------------------------------
           MODULE 5: TEXT ENGINE & EXPORT
           ------------------------------------------- */
        function addNewText() {
            const val = document.getElementById('textInput').value.trim();
            if (!val) return;
            const el = document.createElement('div');
            el.className = 'draggable-element text-white drop-shadow-2xl font-bold';
            el.innerText = val;
            el.style.fontSize = '28px';
            el.style.top = '25%'; el.style.left = '10%';
            el.style.fontFamily = "'Outfit', sans-serif";
            el.onmousedown = (e) => { e.stopPropagation(); selectText(el); };
            el.ontouchstart = (e) => { e.stopPropagation(); selectText(el); };
            makeDraggable(el);
            document.getElementById('dragContainer').appendChild(el);
            document.getElementById('textInput').value = '';
            selectText(el);
        }

        function selectText(el) {
            deselectAll();
            selectedElement = el;
            el.classList.add('selected');
            document.getElementById('textEditPanel').classList.remove('hidden');
            document.getElementById('fontSelect').value = el.style.fontFamily || "'Outfit', sans-serif";
            document.getElementById('sizeRange').value = parseInt(el.style.fontSize);
            document.getElementById('colorPicker').value = rgbToHex(el.style.color);
        }

        function deselectAll() {
            document.querySelectorAll('.draggable-element').forEach(el => el.classList.remove('selected'));
            selectedElement = null;
            document.getElementById('textEditPanel').classList.add('hidden');
        }

        function updateTextStyling() {
            if(!selectedElement) return;
            selectedElement.style.fontFamily = document.getElementById('fontSelect').value;
            selectedElement.style.fontSize = document.getElementById('sizeRange').value + 'px';
            selectedElement.style.color = document.getElementById('colorPicker').value;
        }

        function deleteSelectedText() {
            if(selectedElement) { selectedElement.remove(); deselectAll(); }
        }

        function rgbToHex(rgb) {
            if (!rgb || rgb.startsWith('#')) return rgb || '#ffffff';
            const parts = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (!parts) return '#ffffff';
            const hex = x => parseInt(x).toString(16).padStart(2, '0');
            return "#" + hex(parts[1]) + hex(parts[2]) + hex(parts[3]);
        }

        function makeDraggable(el) {
            let p1 = 0, p2 = 0, p3 = 0, p4 = 0;
            el.onmousedown = (e) => { p3 = e.clientX; p4 = e.clientY; document.onmousemove = drag; document.onmouseup = stop; };
            el.ontouchstart = (e) => { p3 = e.touches[0].clientX; p4 = e.touches[0].clientY; document.ontouchmove = dragT; document.ontouchend = stop; };
            function drag(e) { p1 = p3 - e.clientX; p2 = p4 - e.clientY; p3 = e.clientX; p4 = e.clientY; el.style.top = (el.offsetTop - p2) + "px"; el.style.left = (el.offsetLeft - p1) + "px"; }
            function dragT(e) { if(e.cancelable) e.preventDefault(); const t = e.touches[0]; p1 = p3 - t.clientX; p2 = p4 - t.clientY; p3 = t.clientX; p4 = t.clientY; el.style.top = (el.offsetTop - p2) + "px"; el.style.left = (el.offsetLeft - p1) + "px"; }
            function stop() { document.onmousemove = null; document.ontouchmove = null; }
        }

        /* -------------------------------------------
           MODULE 6: BRANDING & EXPORT
           ------------------------------------------- */
        function setTheme(align) {
            const overlay = document.getElementById('canvasProfileOverlay');
            overlay.className = "relative z-30 p-6 flex border-t border-white/10 transition-all duration-500 w-full items-center";
            const info = overlay.querySelector('#canvasInfoText');
            info.classList.remove('ml-4', 'mr-4', 'mt-3');
            if (align === 'left') { overlay.classList.add('flex-row', 'text-left'); info.classList.add('ml-4'); }
            else if (align === 'center') { overlay.classList.add('flex-col', 'text-center'); info.classList.add('mt-3'); }
            else if (align === 'right') { overlay.classList.add('flex-row-reverse', 'text-right'); info.classList.add('mr-4'); }
        }

        function setShape(shape) {
            document.getElementById('canvasAvatar').className = `w-12 h-12 object-cover border-2 border-white/20 shadow-lg ${shape} bg-slate-800 transition-all duration-300`;
        }

        function loadUser() {
            const saved = localStorage.getItem('ps_brand_v2');
            if (saved) { currentUser = JSON.parse(saved); updateUI(); } 
            else { toggleSetupModal(true); }
        }

        function toggleSetupModal(show) {
            document.getElementById('setupModal').classList.toggle('hidden', !show);
            if(show) {
                document.getElementById('setupName').value = currentUser.name;
                document.getElementById('setupBio').value = currentUser.bio;
                document.getElementById('setupPreview').src = currentUser.pic;
            }
        }

        function saveInitialSetup() {
            const name = document.getElementById('setupName').value.trim();
            if (!name) return showMessage("Naam bhariye!");
            currentUser.name = name;
            currentUser.bio = document.getElementById('setupBio').value.trim();
            localStorage.setItem('ps_brand_v2', JSON.stringify(currentUser));
            updateUI();
            toggleSetupModal(false);
            showMessage("Settings Updated!");
        }

        document.getElementById('setupFile').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => { document.getElementById('setupPreview').src = ev.target.result; currentUser.pic = ev.target.result; };
                reader.readAsDataURL(file);
            }
        };

        async function downloadPoster(scale) {
            deselectAll();
            const btn = event.currentTarget;
            const oldHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner animate-spin text-xs"></i>';
            btn.disabled = true;

            const oldY = window.scrollY;
            window.scrollTo(0,0);
            await new Promise(r => setTimeout(r, 400));

            try {
                const area = document.getElementById('captureArea');
                const canvas = await html2canvas(area, { 
                    scale: scale, useCORS: true, backgroundColor: "#020617",
                    width: area.scrollWidth, height: area.scrollHeight
                });
                const link = document.createElement('a');
                link.download = `poster-${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                showMessage("Poster Exported!");
            } catch(e) { showMessage("Error!"); }
            finally { window.scrollTo(0, oldY); btn.innerHTML = oldHtml; btn.disabled = false; }
        }

        async function sharePoster() {
            deselectAll(); window.scrollTo(0,0); await new Promise(r => setTimeout(r, 300));
            try {
                const area = document.getElementById('captureArea');
                const canvas = await html2canvas(area, { scale: 2.5, useCORS: true, width: area.scrollWidth, height: area.scrollHeight });
                canvas.toBlob(async b => {
                    const f = new File([b], 'poster.png', { type: 'image/png' });
                    if (navigator.share) await navigator.share({ title: 'My Creation', files: [f] });
                    else showMessage("Share blocked!");
                });
            } catch(e) { showMessage("Error!"); }
        }
    </script>
</body>
</html>
